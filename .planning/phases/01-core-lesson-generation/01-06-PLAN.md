---
phase: 01-core-lesson-generation
plan: 06
type: execute
wave: 4
depends_on: ["01-02", "01-03", "01-04", "01-05"]
files_modified:
  - .claude/skills/lesson-designer/SKILL.md
autonomous: false

must_haves:
  truths:
    - "Complete end-to-end workflow executes successfully"
    - "Teacher can input competency and receive .pptx and .docx files"
    - "All Phase 1 requirements are functionally complete"
    - "Output files open correctly and meet quality standards"
  artifacts:
    - path: ".claude/skills/lesson-designer/SKILL.md"
      provides: "Complete Stage 6 and Stage 7 instructions"
      contains: "Stage 6: Validate outputs"
  key_links:
    - from: "SKILL.md Stage 6"
      to: "validate_outputs.py"
      via: "script execution"
      pattern: "python.*validate_outputs"
---

<objective>
Complete the skill workflow with validation and presentation stages, then verify end-to-end functionality.

Purpose: Ensure the complete lesson design workflow executes successfully from teacher input to file delivery. This plan integrates all prior work and includes human verification checkpoint.

Output: Complete SKILL.md with all stages, successful end-to-end test, and teacher verification of output quality.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-core-lesson-generation/01-RESEARCH.md
@.planning/phases/01-core-lesson-generation/01-01-SUMMARY.md
@.planning/phases/01-core-lesson-generation/01-02-SUMMARY.md
@.planning/phases/01-core-lesson-generation/01-03-SUMMARY.md
@.planning/phases/01-core-lesson-generation/01-04-SUMMARY.md
@.planning/phases/01-core-lesson-generation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete SKILL.md with Stage 6 and Stage 7</name>
  <files>
    .claude/skills/lesson-designer/SKILL.md
  </files>
  <action>
Complete SKILL.md with final workflow stages.

**Stage 6: Validate outputs**

Add instructions for Claude to:

1. Run output validation:
   ```bash
   python .claude/skills/lesson-designer/scripts/validate_outputs.py \
     .lesson-designer/sessions/{session_id}/
   ```

2. Review validation report at `07_validation_report.txt`

3. Handle validation results:
   - **PASSED**: Proceed to Stage 7
   - **PASSED WITH WARNINGS**: Review warnings, proceed if acceptable
   - **FAILED**: Address errors before presenting to teacher
     - If slides validation failed: Re-run generate_slides.py
     - If document validation failed: Re-run generate_worksheet.py
     - If assessment missing: Return to Stage 3 to add assessment

4. Common validation issues and fixes:
   ```
   ISSUE: "First slide is not hidden"
   FIX: Check generate_slides.py is using slide._element.set('show', '0')

   ISSUE: "Font size below 16pt minimum"
   FIX: Template may have small fonts - update template

   ISSUE: "Unrendered Jinja2 template tags"
   FIX: Check lesson design JSON has all required fields

   ISSUE: "Missing assessment section"
   FIX: Ensure lesson design includes assessment with questions
   ```

**Stage 7: Present to teacher**

Add instructions for Claude to:

1. Summarize what was created:
   ```
   Your lesson materials are ready!

   Created for: {competency}
   Grade Level: {grade_level}
   Duration: {duration} minutes
   Lesson Type: {lesson_type}

   Files generated:
   - 05_slides.pptx - Slide deck with hidden lesson plan
   - 06_worksheet.docx - Student materials

   Cognitive rigor: {percentage}% higher-order thinking
   Assessment: {assessment_type}
   ```

2. Provide file locations:
   ```
   Files are saved in:
   .lesson-designer/sessions/{session_id}/

   You can open them directly or I can help you review any section.
   ```

3. Offer next steps:
   ```
   What would you like to do next?

   - Review the slides (I'll show you the content)
   - Review the student materials (I'll show you the content)
   - Make adjustments (regenerate with changes)
   - Design another lesson (start fresh)
   - Refine this lesson (Phase 2 adds persona feedback)
   ```

4. If teacher requests changes:
   - For minor changes: Edit the lesson design JSON and regenerate
   - For major changes: Return to appropriate stage (1, 2, 3)
   - Document changes for learning

**Complete workflow checklist (at end of SKILL.md):**

```
COMPLETE LESSON DESIGN WORKFLOW

- [ ] Stage 1: Gather competency requirements
      └── Output: 01_input.json
- [ ] Stage 2: Decompose into skills and knowledge
      └── Output: 02_competency_breakdown.json
- [ ] Stage 2b: Teacher classification and proficiency targets
      └── Output: Updated 02_competency_breakdown.json
- [ ] Stage 3: Design lesson with Marzano taxonomy
      └── Output: 03_lesson_design_v1.json
- [ ] Stage 3b: Validate cognitive rigor
      └── Output: Validation passed → 04_lesson_final.json
- [ ] Stage 5: Generate materials
      └── Output: 05_slides.pptx, 06_worksheet.docx
- [ ] Stage 6: Validate outputs
      └── Output: 07_validation_report.txt
- [ ] Stage 7: Present to teacher
      └── Output: Summary and file locations

Session files location: .lesson-designer/sessions/{session_id}/
```
  </action>
  <verify>
SKILL.md contains complete Stage 6 instructions
SKILL.md contains complete Stage 7 instructions
SKILL.md has complete workflow checklist at end
All stage transitions are clear
Error handling is documented
  </verify>
  <done>
SKILL.md provides complete workflow from input to output
All 7+ stages are documented with clear instructions
Teachers can follow the workflow end-to-end
  </done>
</task>

<task type="auto">
  <name>Task 2: Create end-to-end integration test</name>
  <files>
    .claude/skills/lesson-designer/tests/test_e2e.py
    .claude/skills/lesson-designer/tests/sample_lesson.json
  </files>
  <action>
Create integration test that exercises the complete workflow.

**Create test_e2e.py:**

```python
#!/usr/bin/env python3
"""End-to-end integration test for lesson designer skill."""

import os
import sys
import json
import uuid
import shutil

# Add scripts directory to path
SCRIPT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(SCRIPT_DIR, 'scripts'))

from parse_competency import create_session_directory, save_input
from design_lesson import create_lesson_design, save_lesson_design
from validate_marzano import validate_lesson
from generate_slides import generate_slide_deck
from generate_worksheet import generate_worksheet
from validate_outputs import validate_outputs

def run_e2e_test():
    """Run complete end-to-end test."""

    print("=" * 60)
    print("LESSON DESIGNER END-TO-END TEST")
    print("=" * 60)

    # Generate test session
    session_id = str(uuid.uuid4())[:8]
    print(f"\nSession ID: {session_id}")

    # Create session directory
    session_dir = create_session_directory(session_id)
    print(f"Session directory: {session_dir}")

    # Stage 1: Input
    print("\n--- Stage 1: Input ---")
    input_data = {
        "session_id": session_id,
        "competency": "Students will analyze primary sources to evaluate historical claims",
        "grade_level": "8th grade",
        "lesson_count": 1,
        "lesson_duration": 50,
        "constraints": None
    }
    save_input(session_id, input_data)
    print("Input saved: 01_input.json")

    # Stage 2: Decomposition (simulated - would be Claude's work)
    print("\n--- Stage 2: Decomposition ---")
    breakdown_data = {
        "skill": {
            "verb": "analyze",
            "object": "primary sources",
            "full_statement": "Analyze primary sources to evaluate historical claims"
        },
        "required_knowledge": [
            {"id": "K1", "item": "What primary sources are", "classification": "needs_teaching"},
            {"id": "K2", "item": "How to identify bias", "classification": "needs_teaching"},
            {"id": "K3", "item": "Evidence vs opinion", "classification": "already_assumed"}
        ],
        "target_proficiency": "proficient"
    }
    # Save breakdown (would be saved by parse_competency.py in real workflow)
    with open(os.path.join(session_dir, '02_competency_breakdown.json'), 'w') as f:
        json.dump(breakdown_data, f, indent=2)
    print("Breakdown saved: 02_competency_breakdown.json")

    # Stage 3: Lesson design (simulated)
    print("\n--- Stage 3: Lesson Design ---")
    lesson_design = {
        "title": "Analyzing Primary Sources",
        "grade_level": "8th grade",
        "duration": 50,
        "lesson_type": "introducing",
        "objective": "Students will analyze a primary source document and evaluate the historical claims it makes.",
        "activities": [
            {
                "name": "Prior Knowledge Check",
                "duration": 5,
                "marzano_level": "retrieval",
                "instructions": ["Think of a historical event you know well", "What sources tell us about it?"],
                "materials": ["None"],
                "student_output": "Class discussion",
                "assessment_method": "Observation"
            },
            {
                "name": "What Are Primary Sources?",
                "duration": 10,
                "marzano_level": "comprehension",
                "instructions": ["Define primary source", "Identify types of primary sources", "Contrast with secondary sources"],
                "materials": ["Slide deck", "Examples handout"],
                "student_output": "Notes",
                "assessment_method": "Check for understanding questions"
            },
            {
                "name": "Analyzing a Document",
                "duration": 15,
                "marzano_level": "analysis",
                "instructions": ["Read the provided primary source", "Identify who wrote it and when", "Note any bias or perspective"],
                "materials": ["Primary source document", "Analysis worksheet"],
                "student_output": "Completed analysis worksheet",
                "assessment_method": "Worksheet review"
            },
            {
                "name": "Evaluating Historical Claims",
                "duration": 15,
                "marzano_level": "knowledge_utilization",
                "instructions": ["List claims made in the source", "Evaluate evidence for each claim", "Determine reliability"],
                "materials": ["Claim evaluation rubric"],
                "student_output": "Claim evaluation chart",
                "assessment_method": "Partner review"
            },
            {
                "name": "Exit Ticket",
                "duration": 5,
                "marzano_level": "analysis",
                "instructions": ["Answer exit ticket questions independently"],
                "materials": ["Exit ticket"],
                "student_output": "Completed exit ticket",
                "assessment_method": "Exit ticket collection"
            }
        ],
        "hidden_slide_content": {
            "objective": "Students will analyze a primary source document and evaluate the historical claims it makes.",
            "agenda": [
                {"activity": "Prior Knowledge Check", "duration": 5},
                {"activity": "What Are Primary Sources?", "duration": 10},
                {"activity": "Analyzing a Document", "duration": 15},
                {"activity": "Evaluating Historical Claims", "duration": 15},
                {"activity": "Exit Ticket", "duration": 5}
            ],
            "misconceptions": [
                "Students may think all old documents are primary sources",
                "Students may confuse objectivity with reliability"
            ],
            "delivery_tips": [
                "Use a document relevant to current unit",
                "Model the analysis process before independent work"
            ]
        },
        "vocabulary": [
            {"word": "Primary source", "definition": "A firsthand account created at the time of an event"},
            {"word": "Bias", "definition": "A tendency to favor one perspective over others"},
            {"word": "Reliability", "definition": "The trustworthiness of a source's information"}
        ],
        "assessment": {
            "type": "exit_ticket",
            "description": "Quick check of primary source analysis skills",
            "questions": [
                "What makes a source 'primary'?",
                "What is one way to identify bias in a source?"
            ]
        }
    }

    # Save as v1
    design_path = os.path.join(session_dir, '03_lesson_design_v1.json')
    with open(design_path, 'w') as f:
        json.dump(lesson_design, f, indent=2)
    print("Design saved: 03_lesson_design_v1.json")

    # Stage 3b: Validation
    print("\n--- Stage 3b: Validation ---")
    errors, warnings = validate_lesson(design_path)
    if errors:
        print("VALIDATION FAILED:")
        for error in errors:
            print(f"  ERROR: {error}")
        return False
    print("Validation passed!")

    # Save as final
    final_path = os.path.join(session_dir, '04_lesson_final.json')
    shutil.copy(design_path, final_path)
    print("Final design saved: 04_lesson_final.json")

    # Stage 5: Generate files
    print("\n--- Stage 5: Generate Files ---")

    template_dir = os.path.join(SCRIPT_DIR, 'templates')
    slides_template = os.path.join(template_dir, 'slide_deck.pptx')
    worksheet_template = os.path.join(template_dir, 'student_worksheet.docx')

    slides_output = os.path.join(session_dir, '05_slides.pptx')
    worksheet_output = os.path.join(session_dir, '06_worksheet.docx')

    # Generate slides
    if os.path.exists(slides_template):
        generate_slide_deck(final_path, slides_template, slides_output)
        print(f"Slides generated: {slides_output}")
    else:
        print(f"WARNING: Template not found: {slides_template}")
        print("Creating minimal test slide deck...")
        # Create minimal test output
        from pptx import Presentation
        prs = Presentation()
        slide = prs.slides.add_slide(prs.slide_layouts[0])
        slide.shapes.title.text = "Test Lesson"
        prs.save(slides_output)

    # Generate worksheet
    if os.path.exists(worksheet_template):
        generate_worksheet(final_path, worksheet_template, worksheet_output)
        print(f"Worksheet generated: {worksheet_output}")
    else:
        print(f"WARNING: Template not found: {worksheet_template}")
        print("Creating minimal test document...")
        # Create minimal test output
        from docx import Document
        doc = Document()
        doc.add_heading('Test Worksheet', 0)
        doc.add_paragraph('This is a test document.')
        doc.add_heading('Exit Ticket', 1)
        doc.add_paragraph('What did you learn?')
        doc.save(worksheet_output)

    # Stage 6: Validate outputs
    print("\n--- Stage 6: Validate Outputs ---")
    validation_passed = validate_outputs(session_dir)

    # Summary
    print("\n" + "=" * 60)
    print("TEST SUMMARY")
    print("=" * 60)
    print(f"Session ID: {session_id}")
    print(f"Session directory: {session_dir}")
    print(f"Files created:")
    for f in os.listdir(session_dir):
        size = os.path.getsize(os.path.join(session_dir, f))
        print(f"  - {f} ({size:,} bytes)")
    print(f"\nValidation: {'PASSED' if validation_passed else 'FAILED'}")

    return validation_passed

if __name__ == "__main__":
    success = run_e2e_test()
    sys.exit(0 if success else 1)
```

**Create sample_lesson.json:**

Create a sample lesson design JSON that can be used for manual testing. This should be a complete, valid lesson design that passes Marzano validation.

Save to `.claude/skills/lesson-designer/tests/sample_lesson.json`
  </action>
  <verify>
test_e2e.py exists and is executable
Test exercises all workflow stages
Test generates actual output files
Test validates generated files
sample_lesson.json is valid lesson design
  </verify>
  <done>
End-to-end test exercises complete workflow
Test can identify integration issues
Sample lesson provides manual testing reference
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete lesson designer skill with end-to-end workflow from teacher input to PowerPoint and Word document generation</what-built>
  <how-to-verify>
1. Run the end-to-end test:
   ```bash
   cd C:/Users/david/OneDrive/Desktop/lesson-designer
   python .claude/skills/lesson-designer/tests/test_e2e.py
   ```

2. Check that test passes and files are generated in `.lesson-designer/sessions/{session_id}/`

3. Open the generated PowerPoint file:
   - Verify first slide is hidden (only visible in slide sorter view)
   - Verify slides are sparse (max 5 bullets per slide)
   - Verify fonts are readable (16pt+)
   - Verify presenter notes contain SAY/ASK guidance

4. Open the generated Word document:
   - Verify learning objectives are present
   - Verify activities are listed with instructions
   - Verify assessment/exit ticket section exists
   - Verify no Jinja2 template tags remain ({{ or {%)

5. Verify the skill structure:
   ```
   .claude/skills/lesson-designer/
   ├── SKILL.md (complete workflow)
   ├── MARZANO.md (framework reference)
   ├── templates/
   │   ├── slide_deck.pptx
   │   └── student_worksheet.docx
   └── scripts/
       ├── parse_competency.py
       ├── design_lesson.py
       ├── validate_marzano.py
       ├── generate_slides.py
       ├── generate_worksheet.py
       └── validate_outputs.py
   ```

6. (Optional) Test the actual skill by invoking it:
   - In Claude Code, try: "Design a lesson for 7th grade on analyzing data in tables"
   - Follow the workflow through all stages
   - Verify files are generated
  </how-to-verify>
  <resume-signal>Type "approved" if the skill works end-to-end, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete (including checkpoint):

1. SKILL.md is complete with all stages documented

2. End-to-end test passes:
   - All workflow stages execute
   - Files are generated
   - Validation passes

3. Generated files meet requirements:
   - SLID-01: .pptx file exists
   - SLID-02: First slide is hidden with lesson plan
   - SLID-03: Sparse format
   - SLID-04: 16pt+ fonts
   - MATL-01: .docx file exists
   - MATL-03: Material type matches lesson
   - ASMT-01: Assessment included

4. Human verification confirms:
   - Files open correctly in Office apps
   - Content is usable for teaching
   - Quality meets teacher expectations
</verification>

<success_criteria>
- SKILL.md has complete Stage 6 and Stage 7 instructions
- End-to-end test exercises all workflow stages
- End-to-end test passes with generated files
- Human verifies files open and meet quality standards
- Complete skill structure matches expected layout
- All Phase 1 requirements are functionally complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-lesson-generation/01-06-SUMMARY.md`
</output>
