---
phase: 01-core-lesson-generation
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-03"]
files_modified:
  - .claude/skills/lesson-designer/SKILL.md
  - .claude/skills/lesson-designer/scripts/generate_worksheet.py
autonomous: true

must_haves:
  truths:
    - "Tool generates actual .docx Word documents for student materials"
    - "Materials match lesson type (worksheets, readings, problem sets)"
    - "Each lesson includes formative assessment embedded or as exit ticket"
    - "Word documents use docxtpl Jinja2 templating"
  artifacts:
    - path: ".claude/skills/lesson-designer/scripts/generate_worksheet.py"
      provides: "Word document generation from lesson design JSON"
      exports: ["generate_worksheet", "render_template", "select_material_type"]
    - path: ".claude/skills/lesson-designer/SKILL.md"
      provides: "Updated Stage 5 with Word document generation"
      contains: "Generate Word document"
  key_links:
    - from: "SKILL.md Stage 5"
      to: "generate_worksheet.py"
      via: "script execution"
      pattern: "python.*generate_worksheet"
    - from: "generate_worksheet.py"
      to: "templates/student_worksheet.docx"
      via: "template loading"
      pattern: "DocxTemplate\\(.*worksheet\\.docx"
---

<objective>
Implement Word document generation for student materials with embedded assessment.

Purpose: Generate classroom-ready .docx files that teachers can print and use immediately. Materials should match the lesson type and include formative assessment.

Output: generate_worksheet.py script that creates Word documents from lesson design JSON, with updated SKILL.md Stage 5 instructions for document generation.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-core-lesson-generation/01-RESEARCH.md
@.planning/phases/01-core-lesson-generation/01-01-SUMMARY.md
@.planning/phases/01-core-lesson-generation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Word document generation script</name>
  <files>
    .claude/skills/lesson-designer/scripts/generate_worksheet.py
  </files>
  <action>
Create generate_worksheet.py with student materials generation.

**Key requirements from research:**
- Use docxtpl (pre-installed in Claude environment) for Jinja2 templating
- Load template from templates/student_worksheet.docx
- Select material type based on lesson type
- Include formative assessment (embedded questions or exit ticket)

**Script structure:**

```python
#!/usr/bin/env python3
"""Generate student worksheet/materials from lesson design JSON."""

from docxtpl import DocxTemplate
import json
import sys
import os

def generate_worksheet(lesson_path, template_path, output_path):
    """Generate student materials from lesson design.

    Args:
        lesson_path: Path to lesson design JSON (04_lesson_final.json)
        template_path: Path to Word template
        output_path: Where to save generated .docx
    """

def select_material_type(lesson_type):
    """Determine appropriate material format based on lesson type.

    Args:
        lesson_type: introducing|practicing|applying|synthesizing|novel_application

    Returns:
        Material type: worksheet|reading|problem_set|activity_guide

    Mapping:
        - introducing -> reading + worksheet (comprehension questions)
        - practicing -> problem_set (practice exercises)
        - applying -> worksheet (structured application)
        - synthesizing -> activity_guide (synthesis project)
        - novel_application -> problem_set (open-ended challenges)
    """

def prepare_template_context(lesson, material_type):
    """Prepare context dictionary for docxtpl rendering.

    Context includes:
        - title: Lesson title
        - grade_level: Grade level
        - objectives: List of learning objectives
        - activities: List of activity dictionaries
        - vocabulary: List of vocabulary terms
        - assessment: Assessment section data
        - material_type: Selected material type
    """

def format_activities_for_worksheet(activities, material_type):
    """Format activities appropriately for the material type.

    For worksheets:
        - Include numbered instructions
        - Add reflection questions after each activity
        - Include answer lines

    For problem sets:
        - Focus on practice problems
        - Include worked example first
        - Progressive difficulty

    For readings:
        - Include key information to read
        - Comprehension questions
        - Note-taking section

    For activity guides:
        - Step-by-step instructions
        - Materials checklist
        - Recording section for observations
    """

def add_assessment_section(context, lesson):
    """Add formative assessment to materials.

    Assessment types:
        - exit_ticket: Standalone questions at end
        - embedded: Questions integrated throughout activities
        - performance: Task rubric for demonstration

    CRITICAL: Every lesson MUST include assessment of its objective.
    This is requirement ASMT-01.
    """

def render_template(template_path, context, output_path):
    """Render docxtpl template with context and save.

    Handles:
        - Template loading
        - Context rendering
        - Output saving
        - Validation (no unrendered tags)
    """

def validate_output(output_path):
    """Verify generated file is valid Word document.

    Checks:
        - File exists and can be opened
        - No unrendered Jinja2 tags ({{ or {%)
        - Has minimum content
    """

def main():
    """CLI entry point.

    Usage: python generate_worksheet.py <lesson.json> <template.docx> <output.docx>

    Or with defaults:
    python generate_worksheet.py <lesson.json>
    (uses default template and outputs to same directory as input)
    """
```

**Material type selection logic:**

```python
MATERIAL_TYPE_MAP = {
    'introducing': 'worksheet',      # Reading + comprehension questions
    'practicing': 'problem_set',     # Practice exercises
    'applying': 'worksheet',         # Structured application
    'synthesizing': 'activity_guide', # Project guide
    'novel_application': 'problem_set' # Challenge problems
}

def select_material_type(lesson_type):
    return MATERIAL_TYPE_MAP.get(lesson_type, 'worksheet')
```

**Assessment inclusion (ASMT-01):**

Every generated document MUST include one of:
1. Exit ticket questions at the end
2. Embedded assessment questions throughout activities
3. Performance task with clear success criteria

```python
def add_assessment_section(context, lesson):
    assessment = lesson.get('assessment', {})
    assessment_type = assessment.get('type', 'exit_ticket')

    if assessment_type == 'exit_ticket':
        context['exit_ticket'] = {
            'title': 'Exit Ticket',
            'instructions': 'Answer these questions before leaving class.',
            'questions': assessment.get('questions', [
                'What is one thing you learned today?',
                'What is one question you still have?'
            ])
        }
    elif assessment_type == 'embedded':
        # Assessment questions are already in activities
        context['has_embedded_assessment'] = True
    elif assessment_type == 'performance':
        context['performance_task'] = {
            'description': assessment.get('description', ''),
            'success_criteria': assessment.get('criteria', [])
        }

    return context
```

Cover requirements MATL-01, MATL-03, ASMT-01.
  </action>
  <verify>
generate_worksheet.py exists and is executable
Script uses docxtpl for template rendering
Script selects material type based on lesson type
Script includes assessment in every document
Script validates output (no unrendered tags)
  </verify>
  <done>
generate_worksheet.py creates .docx files from lesson design JSON
Material type matches lesson type
Every document includes formative assessment
Documents use Jinja2 templating for dynamic content
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md with document generation instructions</name>
  <files>
    .claude/skills/lesson-designer/SKILL.md
  </files>
  <action>
Update SKILL.md Stage 5 to include Word document generation.

**Stage 5: Generate materials (Part 2 - Student Materials)**

Add instructions for Claude to:

1. After generating slides, generate student materials:
   ```bash
   python .claude/skills/lesson-designer/scripts/generate_worksheet.py \
     .lesson-designer/sessions/{session_id}/04_lesson_final.json \
     .claude/skills/lesson-designer/templates/student_worksheet.docx \
     .lesson-designer/sessions/{session_id}/06_worksheet.docx
   ```

2. Explain material type selection:
   ```
   The tool automatically selects the appropriate material format:

   | Lesson Type        | Material Format  | Purpose                    |
   |--------------------|------------------|----------------------------|
   | Introducing        | Worksheet        | Reading + comprehension    |
   | Practicing         | Problem Set      | Practice exercises         |
   | Applying           | Worksheet        | Structured application     |
   | Synthesizing       | Activity Guide   | Project instructions       |
   | Novel Application  | Problem Set      | Challenge problems         |

   This ensures students get materials that match the lesson's purpose.
   ```

3. Describe assessment integration:
   ```
   EVERY lesson includes assessment of its objective (Requirement ASMT-01).

   Assessment appears as one of:
   - Exit Ticket: 2-3 questions at the end
   - Embedded Questions: Assessment integrated throughout activities
   - Performance Task: Clear success criteria for demonstration

   The assessment tells teachers whether students achieved the learning objective.
   ```

4. Explain the template system:
   ```
   Student materials use Jinja2 templating:
   - {{ title }} -> Lesson title
   - {% for activity in activities %} -> Activity loop
   - {{ activity.name }} -> Activity name

   This allows teachers to customize the template (fonts, branding, layout)
   without touching the generation code.
   ```

5. If document generation fails:
   - Check that lesson design JSON is valid
   - Check that template file exists
   - Check for unrendered Jinja2 tags (indicates template syntax error)
   - Review error message for specific issue

Include note about formatting limitations:
```
NOTE: Phase 1 generates basic 1.5-spaced documents. Phase 2 will add:
- Double-spaced answer lines (proper room for writing)
- Discussion timing and structure
- Enhanced formatting for different material types
```

This manages expectations while delivering core value.
  </action>
  <verify>
SKILL.md Stage 5 includes document generation command
Stage 5 explains material type selection with table
Stage 5 describes assessment integration (ASMT-01)
Stage 5 includes template system explanation
Stage 5 includes error handling guidance
Stage 5 notes Phase 2 formatting enhancements
  </verify>
  <done>
Stage 5 provides complete instructions for document generation
Teachers understand material type selection
Assessment integration is clearly explained
Phase 2 enhancements are noted for expectation management
  </done>
</task>

<task type="auto">
  <name>Task 3: Update validate_outputs.py for Word documents</name>
  <files>
    .claude/skills/lesson-designer/scripts/validate_outputs.py
  </files>
  <action>
Update validate_outputs.py (created in Plan 04) to include Word document validation.

**Add Word document validation:**

```python
from docx import Document

def validate_docx(filepath):
    """Validate Word document structure and content.

    Checks:
    1. File exists and can be opened
    2. File size is reasonable
    3. No unrendered Jinja2 tags ({{ or {%)
    4. Has required sections (title, objectives, activities, assessment)
    5. Has minimum paragraph count

    Returns:
        (errors: list, warnings: list)
    """
    errors = []
    warnings = []

    # Check file exists
    if not os.path.exists(filepath):
        errors.append(f"File not found: {filepath}")
        return errors, warnings

    # Check file size
    size = os.path.getsize(filepath)
    if size < 1000:
        errors.append(f"File too small ({size} bytes), likely corrupt")
        return errors, warnings

    try:
        doc = Document(filepath)
    except Exception as e:
        errors.append(f"Invalid Word document: {e}")
        return errors, warnings

    # Check for unrendered Jinja2 tags
    text = '\n'.join(p.text for p in doc.paragraphs)
    if '{{' in text or '{%' in text:
        errors.append("Unrendered Jinja2 template tags found - template rendering failed")

    # Check for required content
    text_lower = text.lower()

    required_sections = {
        'objective': 'Learning Objectives section',
        'activit': 'Activities section',  # 'activit' matches 'activity' and 'activities'
    }

    for keyword, description in required_sections.items():
        if keyword not in text_lower:
            warnings.append(f"May be missing {description}")

    # Check for assessment (ASMT-01)
    assessment_keywords = ['exit ticket', 'assessment', 'check your understanding', 'reflection']
    has_assessment = any(kw in text_lower for kw in assessment_keywords)
    if not has_assessment:
        errors.append("Missing assessment section (ASMT-01 requires formative assessment)")

    # Check paragraph count
    if len(doc.paragraphs) < 10:
        warnings.append(f"Document has only {len(doc.paragraphs)} paragraphs - may be incomplete")

    return errors, warnings
```

**Update validate_outputs to check both files:**

```python
def validate_outputs(output_dir, session_id):
    """Validate all generated files.

    Expected files:
        - 05_slides.pptx
        - 06_worksheet.docx

    Generates:
        - 07_validation_report.txt
    """
    all_errors = []
    all_warnings = []

    # Validate PowerPoint
    pptx_path = os.path.join(output_dir, '05_slides.pptx')
    if os.path.exists(pptx_path):
        errors, warnings = validate_pptx(pptx_path)
        all_errors.extend(errors)
        all_warnings.extend(warnings)
    else:
        all_errors.append("Missing: 05_slides.pptx")

    # Validate Word document
    docx_path = os.path.join(output_dir, '06_worksheet.docx')
    if os.path.exists(docx_path):
        errors, warnings = validate_docx(docx_path)
        all_errors.extend(errors)
        all_warnings.extend(warnings)
    else:
        all_errors.append("Missing: 06_worksheet.docx")

    # Generate report
    generate_validation_report(output_dir, all_errors, all_warnings)

    return len(all_errors) == 0
```

This ensures both PowerPoint and Word outputs are validated before presenting to teacher.
  </action>
  <verify>
validate_outputs.py includes validate_docx function
Word validation checks for unrendered Jinja2 tags
Word validation checks for assessment section (ASMT-01)
validate_outputs validates both .pptx and .docx
Validation generates combined report
  </verify>
  <done>
validate_outputs.py validates both PowerPoint and Word documents
Assessment requirement (ASMT-01) is enforced in validation
Complete validation report covers all generated files
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. generate_worksheet.py can create Word document from lesson design:
```bash
python .claude/skills/lesson-designer/scripts/generate_worksheet.py \
  test_lesson.json \
  .claude/skills/lesson-designer/templates/student_worksheet.docx \
  test_output.docx
```

2. Generated Word document:
   - Matches lesson type (worksheet/problem_set/activity_guide)
   - Has no unrendered Jinja2 tags
   - Includes assessment section (exit ticket, embedded, or performance)
   - Opens correctly in Microsoft Word

3. validate_outputs.py catches issues:
   - Returns error if assessment section missing (ASMT-01)
   - Returns error if unrendered template tags
   - Returns warning if content seems incomplete

4. SKILL.md Stage 5 includes complete document generation instructions

5. Coverage of requirements:
   - MATL-01: Tool generates actual .docx files
   - MATL-03: Material type matches lesson type
   - ASMT-01: Each lesson includes assessment of its objective
</verification>

<success_criteria>
- generate_worksheet.py creates valid Word documents
- Material type selection matches lesson type
- Every document includes formative assessment (ASMT-01)
- Documents have no unrendered Jinja2 tags
- validate_outputs.py validates Word documents
- SKILL.md Stage 5 provides clear instructions
- All MATL-01, MATL-03, ASMT-01 requirements are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-lesson-generation/01-05-SUMMARY.md`
</output>
