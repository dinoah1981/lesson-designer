---
phase: 04-multi-persona-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/lesson-designer/scripts/run_multi_persona.py
autonomous: true

must_haves:
  truths:
    - "Script runs lesson through all 4 personas sequentially"
    - "Script produces 4 separate feedback JSON files (one per persona)"
    - "Script reports progress and summary of concerns found"
    - "Script handles missing persona files gracefully"
  artifacts:
    - path: ".claude/skills/lesson-designer/scripts/run_multi_persona.py"
      provides: "Multi-persona orchestrator"
      exports: ["run_all_personas", "main"]
  key_links:
    - from: "run_multi_persona.py"
      to: "PersonaEvaluator"
      via: "import and instantiation"
      pattern: "from persona_evaluator import PersonaEvaluator"
    - from: "run_multi_persona.py"
      to: "personas/*.json"
      via: "PERSONA_DIR / persona_file"
      pattern: "PERSONAS.*struggling_learner.*unmotivated_capable.*interested_capable.*high_achieving"
---

<objective>
Create orchestrator script to run lesson designs through all 4 student personas and produce aggregated feedback files.

Purpose: Single entry point for multi-persona evaluation that the workflow can call in Stage 3.5.
Output: run_multi_persona.py that runs all personas and outputs 4 feedback JSON files.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-persona-validation/04-RESEARCH.md
@.claude/skills/lesson-designer/scripts/persona_evaluator.py
@.claude/skills/lesson-designer/personas/struggling_learner.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create run_multi_persona.py orchestrator</name>
  <files>.claude/skills/lesson-designer/scripts/run_multi_persona.py</files>
  <action>
Create Python script that runs a lesson through all 4 personas.

**Usage:**
```
python run_multi_persona.py <lesson_json> <output_dir>
```

**Implementation details:**

1. **Constants:**
   - PERSONA_DIR = Path(__file__).parent.parent / 'personas'
   - PERSONAS list with all 4 persona filenames:
     - 'struggling_learner.json'
     - 'unmotivated_capable.json'
     - 'interested_capable.json'
     - 'high_achieving.json'

2. **run_all_personas(lesson_path: str, output_dir: str) -> List[str]:**
   - Load lesson JSON from lesson_path
   - Create output_dir if it doesn't exist
   - For each persona in PERSONAS:
     - Load persona JSON from PERSONA_DIR
     - Create PersonaEvaluator with persona config
     - Call evaluator.evaluate_lesson(lesson)
     - Write feedback to output_dir/03_feedback_{persona_id}.json
     - Print progress: "Evaluating with {persona_id}..."
     - Print concern count: "  [checkmark] {N} concerns identified"
   - Return list of feedback file paths

3. **Error handling:**
   - If persona file not found: print warning, skip that persona, continue with others
   - If lesson file not found: raise FileNotFoundError with clear message
   - If output_dir can't be created: raise with clear message

4. **Summary output at end:**
   - Total personas evaluated
   - List of feedback files created
   - Summary table: persona | rating | concern count

5. **CLI (argparse):**
   - lesson: positional, path to lesson JSON
   - output_dir: positional, directory for feedback files
   - --verbose: optional flag for detailed output

**Return exit code 0 if all 4 personas run, exit code 1 if any personas failed to run.**

**Import PersonaEvaluator correctly:**
```python
from persona_evaluator import PersonaEvaluator
```
(Same directory import, not absolute)
  </action>
  <verify>
python -c "import sys; sys.path.insert(0, '.claude/skills/lesson-designer/scripts'); from run_multi_persona import run_all_personas; print('Import OK')"
  </verify>
  <done>Script is importable, has run_all_personas function, handles all 4 personas, produces feedback files in specified output directory</done>
</task>

<task type="auto">
  <name>Task 2: Add shebang and make executable</name>
  <files>.claude/skills/lesson-designer/scripts/run_multi_persona.py</files>
  <action>
Ensure the script has:

1. Shebang line: `#!/usr/bin/env python3`
2. Module docstring explaining:
   - Purpose: Run lesson evaluation through multiple personas
   - Usage: python run_multi_persona.py <lesson_json> <output_dir>
   - Example with actual paths
   - Output: List of feedback JSON file paths

3. Type hints for all functions

4. Main block check:
```python
if __name__ == '__main__':
    main()
```

**Also verify the script can actually find the personas directory using relative paths correctly when run from any working directory.**
  </action>
  <verify>
cd "C:\Users\david\OneDrive\Desktop\lesson-designer" && python .claude/skills/lesson-designer/scripts/run_multi_persona.py --help
  </verify>
  <done>Script shows help output with usage information, lesson and output_dir arguments documented</done>
</task>

</tasks>

<verification>
1. Script exists at .claude/skills/lesson-designer/scripts/run_multi_persona.py
2. Script is syntactically valid: python -m py_compile .claude/skills/lesson-designer/scripts/run_multi_persona.py
3. Script imports PersonaEvaluator successfully
4. Script --help shows correct usage
5. PERSONAS list contains all 4 persona filenames
6. run_all_personas function returns list of paths
7. Error handling for missing files is present (try/except or Path.exists checks)
</verification>

<success_criteria>
- run_multi_persona.py created and importable
- Runs lesson through 4 personas (when persona files exist)
- Creates feedback files with naming convention 03_feedback_{persona_id}.json
- Reports progress to stdout
- Returns list of feedback file paths
- Handles missing persona files gracefully (warns, continues with others)
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-persona-validation/04-02-SUMMARY.md`
</output>
