---
phase: 02-material-quality-formatting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/skills/lesson-designer/scripts/generate_simulation.py
  - .claude/skills/lesson-designer/templates/simulation_template.html
autonomous: true

must_haves:
  truths:
    - "Tool can generate HTML/JS simulation files when competency involves interactive visualization"
    - "Simulations include student instructions and keyboard controls"
    - "Generated HTML files are self-contained (p5.js via CDN)"
  artifacts:
    - path: ".claude/skills/lesson-designer/scripts/generate_simulation.py"
      provides: "Simulation generation from lesson competency"
      contains: "p5.js"
    - path: ".claude/skills/lesson-designer/templates/simulation_template.html"
      provides: "Jinja2 HTML template for simulations"
      contains: "cdn.jsdelivr.net/npm/p5"
  key_links:
    - from: "generate_simulation.py"
      to: "simulation_template.html"
      via: "Jinja2 Template rendering"
      pattern: "Template.*render"
---

<objective>
Create simulation generator that produces HTML/JS interactive visualizations using p5.js when appropriate for lesson competencies.

Purpose: Some competencies benefit from interactive simulations (physics, economics, biology, etc.). This addresses requirement MATL-04 by creating a generator that can produce self-contained HTML files with p5.js simulations.

Output: New generate_simulation.py script and simulation_template.html that can generate educational simulations from competency descriptions.
</objective>

<execution_context>
@C:\Users\david\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\david\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-material-quality-formatting/02-RESEARCH.md

# Reference existing generator patterns
@.claude/skills/lesson-designer/scripts/generate_worksheet.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create simulation HTML template</name>
  <files>.claude/skills/lesson-designer/templates/simulation_template.html</files>
  <action>
Create the Jinja2 HTML template for p5.js simulations:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
        }
        h1 {
            color: #2D5A87;
            margin-bottom: 10px;
        }
        .instructions {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .instructions h2 {
            color: #2D5A87;
            margin-top: 0;
            font-size: 1.2em;
        }
        .instructions p {
            color: #333;
            line-height: 1.6;
        }
        .controls {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .controls strong {
            color: #2D5A87;
        }
        .canvas-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
        }
        canvas {
            border: 2px solid #2D5A87;
            border-radius: 4px;
        }
        .learning-objective {
            background: #F4D03F;
            color: #2C3E50;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        /* Accessibility: focus indicator */
        canvas:focus {
            outline: 3px solid #F4D03F;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>

        {% if learning_objective %}
        <div class="learning-objective">
            ðŸŽ¯ Learning Objective: {{ learning_objective }}
        </div>
        {% endif %}

        <div class="instructions">
            <h2>ðŸ“‹ Instructions</h2>
            <p>{{ instructions }}</p>

            <div class="controls">
                <strong>Controls:</strong>
                <ul>
                    {% for control in controls %}
                    <li>{{ control }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="canvas-container">
            <!-- p5.js will create the canvas here -->
        </div>
    </div>

    <script>
// p5.js Simulation: {{ title }}
// Generated for educational use

{{ sketch_code }}
    </script>
</body>
</html>
```

Important features:
- p5.js loaded from CDN (no local dependencies)
- Learning objective displayed prominently
- Controls listed for accessibility
- Clean, educational styling matching slide design system colors
- Focus indicator on canvas for keyboard navigation
  </action>
  <verify>
Check template file exists and has required elements:
```bash
cd "C:\Users\david\OneDrive\Desktop\lesson-designer"
type .claude\skills\lesson-designer\templates\simulation_template.html | findstr "cdn.jsdelivr"
```
Should find the p5.js CDN URL.
  </verify>
  <done>
- Template file created at templates/simulation_template.html
- Includes p5.js CDN script tag
- Has Jinja2 placeholders for title, instructions, controls, sketch_code
- Styled to match lesson-designer design system (blue #2D5A87, gold #F4D03F)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create simulation generator script</name>
  <files>.claude/skills/lesson-designer/scripts/generate_simulation.py</files>
  <action>
Create the simulation generator script:

```python
#!/usr/bin/env python3
"""
Generate HTML/JS Educational Simulations

Creates self-contained HTML files with p5.js simulations for interactive
learning activities. Simulations are generated based on competency keywords
and lesson context.

Requirements covered:
    - MATL-04: Tool can generate HTML/JS simulation programs when appropriate
"""

import json
import os
import sys
from typing import Dict, Any, Optional, Tuple
from jinja2 import Template

# Simulation templates by domain/keyword
SIMULATION_TEMPLATES = {
    'supply_demand': {
        'title': 'Supply and Demand Simulation',
        'instructions': 'Watch how price changes affect supply and demand curves. Drag the price slider to see equilibrium shift.',
        'controls': [
            'Click and drag the price slider',
            'Press R to reset to default',
            'Press SPACE to toggle animation'
        ],
        'sketch': '''
let priceSlider;
let price = 50;
let animating = false;

function setup() {
    let canvas = createCanvas(600, 400);
    canvas.attribute('tabindex', '0');
    canvas.attribute('aria-label', 'Supply and demand curve simulation');
    textSize(14);
}

function draw() {
    background(245);

    // Axes
    stroke(0);
    strokeWeight(2);
    line(50, 350, 550, 350); // x-axis (quantity)
    line(50, 350, 50, 50);   // y-axis (price)

    // Labels
    noStroke();
    fill(0);
    textAlign(CENTER);
    text('Quantity', 300, 380);
    push();
    translate(20, 200);
    rotate(-PI/2);
    text('Price', 0, 0);
    pop();

    // Price line
    let priceY = map(price, 0, 100, 350, 50);

    // Supply curve (upward sloping)
    stroke(0, 100, 200);
    strokeWeight(3);
    noFill();
    beginShape();
    for (let q = 0; q <= 500; q += 10) {
        let p = 50 + q * 0.5;
        let y = map(p, 0, 100, 350, 50);
        vertex(50 + q, y);
    }
    endShape();
    fill(0, 100, 200);
    noStroke();
    text('Supply', 520, map(75, 0, 100, 350, 50));

    // Demand curve (downward sloping)
    stroke(200, 50, 50);
    strokeWeight(3);
    noFill();
    beginShape();
    for (let q = 0; q <= 500; q += 10) {
        let p = 100 - q * 0.15;
        let y = map(p, 0, 100, 350, 50);
        vertex(50 + q, y);
    }
    endShape();
    fill(200, 50, 50);
    noStroke();
    text('Demand', 450, map(25, 0, 100, 350, 50));

    // Price line
    stroke(244, 208, 63);
    strokeWeight(2);
    line(50, priceY, 550, priceY);
    fill(244, 208, 63);
    noStroke();
    text('Price: $' + price.toFixed(0), 500, priceY - 10);

    // Calculate equilibrium
    let eqPrice = 62;  // Where curves cross
    let eqQuantity = 250;
    fill(100, 200, 100);
    ellipse(50 + eqQuantity, map(eqPrice, 0, 100, 350, 50), 15, 15);
    text('Equilibrium', 50 + eqQuantity, map(eqPrice, 0, 100, 350, 50) - 15);

    // Instructions
    fill(100);
    textAlign(LEFT);
    text('Click and drag vertically to change price', 60, 30);

    if (animating) {
        price = 50 + 30 * sin(frameCount * 0.02);
    }
}

function mousePressed() {
    if (mouseX > 50 && mouseX < 550 && mouseY > 50 && mouseY < 350) {
        updatePrice();
    }
}

function mouseDragged() {
    if (mouseX > 50 && mouseX < 550) {
        updatePrice();
    }
}

function updatePrice() {
    price = map(mouseY, 350, 50, 0, 100);
    price = constrain(price, 0, 100);
}

function keyPressed() {
    if (key === 'r' || key === 'R') {
        price = 50;
        animating = false;
    }
    if (key === ' ') {
        animating = !animating;
    }
}
'''
    },

    'velocity': {
        'title': 'Understanding Velocity',
        'instructions': 'Observe how velocity (speed and direction) affects motion. The arrow shows the velocity vector.',
        'controls': [
            'Click anywhere to set new position',
            'Arrow keys to change velocity direction',
            'Press +/- to change speed',
            'Press R to reset'
        ],
        'sketch': '''
let position, velocity;
let speed = 3;

function setup() {
    let canvas = createCanvas(600, 400);
    canvas.attribute('tabindex', '0');
    canvas.attribute('aria-label', 'Velocity and motion simulation');
    resetSimulation();
}

function draw() {
    background(245);

    // Update position
    position.add(velocity);

    // Wrap around edges
    if (position.x > width) position.x = 0;
    if (position.x < 0) position.x = width;
    if (position.y > height) position.y = 0;
    if (position.y < 0) position.y = height;

    // Draw object
    fill(45, 90, 135);
    noStroke();
    ellipse(position.x, position.y, 30, 30);

    // Draw velocity vector
    stroke(244, 208, 63);
    strokeWeight(3);
    let arrowEnd = p5.Vector.add(position, p5.Vector.mult(velocity, 15));
    line(position.x, position.y, arrowEnd.x, arrowEnd.y);

    // Arrowhead
    push();
    translate(arrowEnd.x, arrowEnd.y);
    rotate(velocity.heading());
    fill(244, 208, 63);
    noStroke();
    triangle(0, 0, -10, -5, -10, 5);
    pop();

    // Info display
    fill(50);
    noStroke();
    textSize(14);
    text('Velocity: (' + velocity.x.toFixed(1) + ', ' + velocity.y.toFixed(1) + ')', 10, 25);
    text('Speed: ' + velocity.mag().toFixed(1) + ' px/frame', 10, 45);
    text('Use arrow keys to change direction, +/- for speed', 10, height - 15);
}

function resetSimulation() {
    position = createVector(width/2, height/2);
    velocity = createVector(speed, 0);
}

function mousePressed() {
    position = createVector(mouseX, mouseY);
}

function keyPressed() {
    if (keyCode === LEFT_ARROW) velocity.rotate(-0.2);
    if (keyCode === RIGHT_ARROW) velocity.rotate(0.2);
    if (keyCode === UP_ARROW) velocity.setMag(velocity.mag() + 0.5);
    if (keyCode === DOWN_ARROW) velocity.setMag(max(0.5, velocity.mag() - 0.5));
    if (key === 'r' || key === 'R') resetSimulation();
    if (key === '+' || key === '=') velocity.setMag(velocity.mag() + 1);
    if (key === '-' || key === '_') velocity.setMag(max(0.5, velocity.mag() - 1));
}
'''
    },

    'ecosystem': {
        'title': 'Ecosystem Population Dynamics',
        'instructions': 'Watch predator-prey relationships in action. Green dots are prey, red dots are predators.',
        'controls': [
            'Press P to add prey',
            'Press D to add predator',
            'Press R to reset',
            'Press SPACE to pause/resume'
        ],
        'sketch': '''
let prey = [];
let predators = [];
let paused = false;

function setup() {
    let canvas = createCanvas(600, 400);
    canvas.attribute('tabindex', '0');
    resetSimulation();
}

function draw() {
    background(245);

    if (!paused) {
        // Update prey
        for (let i = prey.length - 1; i >= 0; i--) {
            prey[i].move();
            if (random() < 0.002) {
                prey.push(new Organism(prey[i].x, prey[i].y, 'prey'));
            }
        }

        // Update predators
        for (let i = predators.length - 1; i >= 0; i--) {
            let p = predators[i];
            p.hunt(prey);
            p.move();
            p.energy--;
            if (p.energy <= 0) {
                predators.splice(i, 1);
            } else if (p.energy > 150 && random() < 0.01) {
                predators.push(new Organism(p.x, p.y, 'predator'));
            }
        }
    }

    // Draw all
    for (let p of prey) p.display();
    for (let p of predators) p.display();

    // Stats
    fill(50);
    noStroke();
    textSize(14);
    text('Prey: ' + prey.length, 10, 25);
    text('Predators: ' + predators.length, 10, 45);
    if (paused) text('PAUSED', width/2 - 30, 25);
}

function resetSimulation() {
    prey = [];
    predators = [];
    for (let i = 0; i < 50; i++) {
        prey.push(new Organism(random(width), random(height), 'prey'));
    }
    for (let i = 0; i < 5; i++) {
        predators.push(new Organism(random(width), random(height), 'predator'));
    }
}

function keyPressed() {
    if (key === 'r' || key === 'R') resetSimulation();
    if (key === ' ') paused = !paused;
    if (key === 'p' || key === 'P') prey.push(new Organism(random(width), random(height), 'prey'));
    if (key === 'd' || key === 'D') predators.push(new Organism(random(width), random(height), 'predator'));
}

class Organism {
    constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.energy = type === 'predator' ? 100 : 0;
        this.vx = random(-1, 1);
        this.vy = random(-1, 1);
    }

    move() {
        this.vx += random(-0.2, 0.2);
        this.vy += random(-0.2, 0.2);
        this.vx = constrain(this.vx, -2, 2);
        this.vy = constrain(this.vy, -2, 2);
        this.x += this.vx;
        this.y += this.vy;
        this.x = (this.x + width) % width;
        this.y = (this.y + height) % height;
    }

    hunt(preyList) {
        for (let i = preyList.length - 1; i >= 0; i--) {
            let d = dist(this.x, this.y, preyList[i].x, preyList[i].y);
            if (d < 15) {
                preyList.splice(i, 1);
                this.energy += 50;
                break;
            }
        }
    }

    display() {
        noStroke();
        if (this.type === 'prey') {
            fill(100, 200, 100);
            ellipse(this.x, this.y, 10, 10);
        } else {
            fill(200, 100, 100);
            ellipse(this.x, this.y, 15, 15);
        }
    }
}
'''
    }
}

# Keywords that suggest simulation would be appropriate
SIMULATION_KEYWORDS = {
    'supply_demand': ['supply', 'demand', 'equilibrium', 'market', 'price'],
    'velocity': ['velocity', 'motion', 'speed', 'direction', 'vector', 'physics'],
    'ecosystem': ['ecosystem', 'population', 'predator', 'prey', 'food chain', 'biology']
}


def detect_simulation_type(competency: str, lesson_context: Optional[Dict] = None) -> Optional[str]:
    """
    Detect if competency suggests a simulation and which type.

    Returns simulation type key or None if no simulation appropriate.
    """
    competency_lower = competency.lower()

    for sim_type, keywords in SIMULATION_KEYWORDS.items():
        if any(kw in competency_lower for kw in keywords):
            return sim_type

    return None


def should_generate_simulation(competency: str) -> bool:
    """Check if simulation would be appropriate for this competency."""
    return detect_simulation_type(competency) is not None


def load_template() -> Template:
    """Load the HTML simulation template."""
    template_path = os.path.join(
        os.path.dirname(__file__),
        '..', 'templates', 'simulation_template.html'
    )

    with open(template_path, 'r', encoding='utf-8') as f:
        return Template(f.read())


def generate_simulation(
    competency: str,
    learning_objective: str = None,
    output_path: str = None
) -> Tuple[bool, str]:
    """
    Generate HTML simulation file for a competency.

    Args:
        competency: The competency statement
        learning_objective: Optional explicit learning objective
        output_path: Output file path (default: simulation.html in current dir)

    Returns:
        Tuple of (success, output_path or error message)
    """
    # Detect simulation type
    sim_type = detect_simulation_type(competency)

    if sim_type is None:
        return False, "No appropriate simulation found for this competency"

    # Get template data
    sim_data = SIMULATION_TEMPLATES[sim_type]

    # Load HTML template
    template = load_template()

    # Render HTML
    html_content = template.render(
        title=sim_data['title'],
        learning_objective=learning_objective or competency,
        instructions=sim_data['instructions'],
        controls=sim_data['controls'],
        sketch_code=sim_data['sketch']
    )

    # Determine output path
    if output_path is None:
        output_path = f"{sim_type}_simulation.html"

    # Write file
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(html_content)

    return True, output_path


def main():
    """CLI entry point."""
    if len(sys.argv) < 2:
        print("Usage: python generate_simulation.py <competency> [output.html]")
        print()
        print("Generates an educational simulation if appropriate for the competency.")
        print()
        print("Supported simulation types:")
        for sim_type, keywords in SIMULATION_KEYWORDS.items():
            print(f"  - {sim_type}: keywords = {', '.join(keywords[:3])}...")
        sys.exit(1)

    competency = sys.argv[1]
    output_path = sys.argv[2] if len(sys.argv) >= 3 else None

    # Check if simulation is appropriate
    if not should_generate_simulation(competency):
        print(f"No simulation template matches competency: {competency}")
        print("Simulation generation is optional - only for interactive concepts.")
        sys.exit(0)

    success, result = generate_simulation(competency, output_path=output_path)

    if success:
        print(f"Simulation generated: {result}")
        print("Open in browser to test.")
        sys.exit(0)
    else:
        print(f"Error: {result}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
```

Key features:
- detect_simulation_type() identifies when simulation is appropriate
- SIMULATION_TEMPLATES contains pre-built p5.js sketches for common topics
- Template system allows easy addition of new simulation types
- CLI interface for testing
- Graceful handling when no simulation is appropriate (exits 0, not failure)
  </action>
  <verify>
Test simulation generation:
```bash
cd "C:\Users\david\OneDrive\Desktop\lesson-designer"
python .claude/skills/lesson-designer/scripts/generate_simulation.py "Students will analyze supply and demand to predict market equilibrium" test_simulation.html
type test_simulation.html | findstr "p5.min.js"
```
Should generate HTML with p5.js reference.
  </verify>
  <done>
- generate_simulation.py created with CLI interface
- Template rendering produces valid HTML
- Supply/demand, velocity, and ecosystem simulations included
- Keyword detection identifies appropriate competencies
- Non-matching competencies handled gracefully (exit 0, informational message)
  </done>
</task>

</tasks>

<verification>
1. Template file exists at templates/simulation_template.html
2. Script generates HTML for matching competencies (supply/demand, velocity, ecosystem)
3. Generated HTML loads p5.js from CDN
4. Simulation includes instructions and keyboard controls
5. Script exits cleanly (code 0) for non-matching competencies
</verification>

<success_criteria>
- MATL-04 satisfied: Tool can generate HTML/JS simulation programs when appropriate
- Simulations are self-contained (single HTML file, CDN dependencies)
- Simulations include student instructions and keyboard controls
- Generator gracefully handles competencies without matching simulations
- At least 3 simulation templates available (economics, physics, biology)
</success_criteria>

<output>
After completion, create `.planning/phases/02-material-quality-formatting/02-03-SUMMARY.md`
</output>
